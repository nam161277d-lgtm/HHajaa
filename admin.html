<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quản trị viên</title>
  <style>
    body {
      background: #1e1e1e;
      color: #e0e0e0;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    h1, h2 {
      text-align: center;
    }
    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 10px;
    }
    input, button, select {
      font-size: 1em;
    }
    .form-group {
      margin-bottom: 15px;
      display: flex;
      flex-direction: column;
    }
    .form-group label {
      margin-bottom: 5px;
    }
    .form-group input[type="text"], 
    .form-group input[type="password"] {
      padding: 8px;
      border: 1px solid #555;
      border-radius: 4px;
      background: #2b2b2b;
      color: #fff;
    }
    .actions {
      text-align: center;
      margin-top: 20px;
    }
    .actions button {
      background: #424242;
      color: #fff;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
    }
    .actions button:hover {
      background: #616161;
    }
    nav {
      text-align: center;
      margin-bottom: 20px;
    }
    nav button {
      background: #333;
      color: #fff;
      border: none;
      padding: 8px 15px;
      margin: 0 5px;
      border-radius: 4px;
      cursor: pointer;
    }
    nav button.active {
      background: #616161;
    }
    #admin-main {
      display: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    table th, table td {
      border: 1px solid #444;
      padding: 8px;
      text-align: left;
    }
    table th {
      background: #333;
    }
    .badge {
      color: #ff9800;
      font-weight: bold;
    }
    .btn-small {
      padding: 4px 8px;
      margin: 0 2px;
      background: #546e7a;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    .btn-small:hover {
      background: #78909c;
    }
    .scrollable {
      max-width: 250px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #history-list {
      list-style: none;
      padding-left: 0;
    }
    #history-list li {
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div class="container" id="admin-login">
    <h1>Admin Đăng nhập</h1>
    <div class="form-group">
      <label for="admin-user">Tài khoản:</label>
      <input type="text" id="admin-user" />
    </div>
    <div class="form-group">
      <label for="admin-pass">Mật khẩu:</label>
      <input type="password" id="admin-pass" />
    </div>
    <div class="actions">
      <button id="btn-admin-login">Đăng nhập</button>
    </div>
  </div>

  <div class="container" id="admin-main">
    <h2>Trang Quản trị</h2>
    <nav>
      <button id="tab-users" class="active">Người dùng</button>
      <button id="tab-sessions">Phiên hoạt động</button>
      <button id="tab-history">Lịch sử</button>
      <button id="btn-admin-logout" style="float:right;">Đăng xuất</button>
    </nav>
    <!-- User management -->
    <div id="section-users">
      <h3>Danh sách User</h3>
      <table>
        <thead>
          <tr><th>SĐT</th><th>Email</th><th>Hết hạn</th><th>Còn lại</th><th>Thao tác</th></tr>
        </thead>
        <tbody id="user-table"></tbody>
      </table>
      <p style="font-size: 0.9em;"><span class="badge">*</span> Ký hiệu * bên tài khoản nghĩa là tài khoản đang đăng nhập ở nhiều nơi.</p>
      <!-- 2FA keys modal (simple implementation as a hidden div) -->
      <div id="keys-modal" style="display:none; background:#263238; padding:15px; border-radius:4px;">
        <h4>2FA của <span id="modal-username"></span>:</h4>
        <ul id="keys-list" style="list-style:none; padding-left:0;"></ul>
        <button class="btn-small" id="btn-close-keys">Đóng</button>
      </div>
    </div>
    <!-- Active sessions -->
    <div id="section-sessions" style="display:none;">
      <h3>Phiên đang hoạt động</h3>
      <table>
        <thead>
          <tr><th>User</th><th>Thiết bị (User Agent)</th><th>Đăng nhập lúc</th><th></th></tr>
        </thead>
        <tbody id="sessions-table"></tbody>
      </table>
    </div>
    <!-- Reset history -->
    <div id="section-history" style="display:none;">
      <h3>Lịch sử thao tác</h3>
      <ul id="history-list"></ul>
    </div>
  </div>

  <script>
    // Data
    let adminUser = null;
    // Ensure an admin account exists (default credentials for demo)
    function ensureAdminAccount() {
      let users = JSON.parse(localStorage.getItem('users') || '[]');
      if (!users.some(u => u.isAdmin)) {
        // Create default admin if not exist
        users.push({
          id: 'admin',
          phone: 'admin',
          email: 'admin@admin.com',
          password: 'admin123',
          isAdmin: true,
          expiry: null,
          twoFA: []
        });
        localStorage.setItem('users', JSON.stringify(users));
      }
    }
    ensureAdminAccount();

    // Admin login
    document.getElementById('btn-admin-login').onclick = () => {
      const user = document.getElementById('admin-user').value.trim();
      const pass = document.getElementById('admin-pass').value;
      let users = JSON.parse(localStorage.getItem('users') || '[]');
      let admin = users.find(u => u.isAdmin && (u.email === user || u.phone === user) && u.password === pass);
      if (!admin) {
        alert("Đăng nhập admin thất bại!");
        return;
      }
      adminUser = admin;
      document.getElementById('admin-login').style.display = 'none';
      document.getElementById('admin-main').style.display = 'block';
      renderUserTable();
      renderSessionsTable();
      renderHistoryList();
    };

    // Admin logout
    document.getElementById('btn-admin-logout').onclick = () => {
      adminUser = null;
      document.getElementById('admin-main').style.display = 'none';
      document.getElementById('admin-login').style.display = 'block';
      document.getElementById('admin-user').value = '';
      document.getElementById('admin-pass').value = '';
    };

    // Tab switching
    document.getElementById('tab-users').onclick = () => {
      document.getElementById('section-users').style.display = 'block';
      document.getElementById('section-sessions').style.display = 'none';
      document.getElementById('section-history').style.display = 'none';
      document.getElementById('tab-users').classList.add('active');
      document.getElementById('tab-sessions').classList.remove('active');
      document.getElementById('tab-history').classList.remove('active');
    };
    document.getElementById('tab-sessions').onclick = () => {
      document.getElementById('section-users').style.display = 'none';
      document.getElementById('section-sessions').style.display = 'block';
      document.getElementById('section-history').style.display = 'none';
      document.getElementById('tab-users').classList.remove('active');
      document.getElementById('tab-sessions').classList.add('active');
      document.getElementById('tab-history').classList.remove('active');
    };
    document.getElementById('tab-history').onclick = () => {
      document.getElementById('section-users').style.display = 'none';
      document.getElementById('section-sessions').style.display = 'none';
      document.getElementById('section-history').style.display = 'block';
      document.getElementById('tab-users').classList.remove('active');
      document.getElementById('tab-sessions').classList.remove('active');
      document.getElementById('tab-history').classList.add('active');
    };

    // Render user table
    function renderUserTable() {
      let users = JSON.parse(localStorage.getItem('users') || '[]');
      const tbody = document.getElementById('user-table');
      tbody.innerHTML = "";
      users.filter(u => !u.isAdmin).forEach(u => {
        const tr = document.createElement('tr');
        const tdPhone = document.createElement('td');
        tdPhone.textContent = u.phone;
        const tdEmail = document.createElement('td');
        tdEmail.textContent = u.email;
        const tdExpiry = document.createElement('td');
        if (u.expiry) {
          let expDate = new Date(u.expiry);
          tdExpiry.textContent = expDate.toLocaleDateString();
        } else {
          tdExpiry.textContent = "Không giới hạn";
        }
        const tdDays = document.createElement('td');
        if (u.expiry) {
          const daysLeft = Math.ceil((u.expiry - Date.now()) / (1000*60*60*24));
          tdDays.textContent = daysLeft >= 0 ? daysLeft.toString() : "0";
        } else {
          tdDays.textContent = "-";
        }
        const tdActions = document.createElement('td');
        // Reset password button
        const resetBtn = document.createElement('button');
        resetBtn.className = 'btn-small';
        resetBtn.textContent = "Reset MK";
        resetBtn.onclick = () => {
          const newPass = prompt(`Nhập mật khẩu mới cho ${u.email || u.phone}:`);
          if (newPass !== null && newPass !== "") {
            u.password = newPass;
            localStorage.setItem('users', JSON.stringify(users));
            logHistory(`Reset mật khẩu tài khoản ${u.email || u.phone}`);
            alert("Đã đặt lại mật khẩu người dùng.");
          }
        };
        // Grant days button
        const grantBtn = document.createElement('button');
        grantBtn.className = 'btn-small';
        grantBtn.textContent = "Cấp ngày";
        grantBtn.onclick = () => {
          const daysStr = prompt(`Nhập số ngày sử dụng cho ${u.email || u.phone}:`);
          const days = parseInt(daysStr);
          if (!isNaN(days) && days > 0) {
            const now = Date.now();
            u.expiry = now + days * 24*60*60*1000;
            localStorage.setItem('users', JSON.stringify(users));
            logHistory(`Cấp quyền sử dụng ${days} ngày cho tài khoản ${u.email || u.phone}`);
            renderUserTable();
            alert(`Đã cập nhật thời hạn sử dụng cho người dùng (còn ${days} ngày).`);
          }
        };
        // View 2FA keys button
        const keysBtn = document.createElement('button');
        keysBtn.className = 'btn-small';
        keysBtn.textContent = "Xem 2FA";
        keysBtn.onclick = () => {
          document.getElementById('modal-username').innerText = u.email || u.phone;
          const keysList = document.getElementById('keys-list');
          keysList.innerHTML = "";
          if (u.twoFA && u.twoFA.length > 0) {
            u.twoFA.forEach(item => {
              const li = document.createElement('li');
              li.textContent = `${item.name}: ${item.secret}`;
              // Delete key by admin
              const delBtn = document.createElement('button');
              delBtn.className = 'btn-small';
              delBtn.textContent = "Xóa";
              delBtn.style.marginLeft = '10px';
              delBtn.onclick = () => {
                if (confirm(`Xóa 2FA "${item.name}" của user ${u.email || u.phone}?`)) {
                  u.twoFA = u.twoFA.filter(k => k !== item);
                  localStorage.setItem('users', JSON.stringify(users));
                  li.remove();
                }
              };
              li.appendChild(delBtn);
              keysList.appendChild(li);
            });
          } else {
            const li = document.createElement('li');
            li.textContent = "(Không có 2FA nào)";
            keysList.appendChild(li);
          }
          document.getElementById('keys-modal').style.display = 'block';
        };
        // Mark if multiple sessions
        const sessions = JSON.parse(localStorage.getItem('sessions') || '[]');
        const userSessions = sessions.filter(s => s.userId === u.id);
        if (userSessions.length > 1) {
          // Add a star or badge to indicate multiple sessions
          tdPhone.innerHTML = u.phone + ' <span class="badge">*</span>';
        }
        tdActions.appendChild(resetBtn);
        tdActions.appendChild(grantBtn);
        tdActions.appendChild(keysBtn);
        tr.appendChild(tdPhone);
        tr.appendChild(tdEmail);
        tr.appendChild(tdExpiry);
        tr.appendChild(tdDays);
        tr.appendChild(tdActions);
        tbody.appendChild(tr);
      });
    }
    // Close keys modal
    document.getElementById('btn-close-keys').onclick = () => {
      document.getElementById('keys-modal').style.display = 'none';
    };

    // Render sessions table
    function renderSessionsTable() {
      const sessions = JSON.parse(localStorage.getItem('sessions') || '[]');
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const tbody = document.getElementById('sessions-table');
      tbody.innerHTML = "";
      sessions.forEach(sess => {
        const tr = document.createElement('tr');
        const user = users.find(u => u.id === sess.userId);
        const tdUser = document.createElement('td');
        tdUser.textContent = user ? (user.email || user.phone) : `(UID ${sess.userId})`;
        const tdUA = document.createElement('td');
        tdUA.className = 'scrollable';
        tdUA.title = sess.userAgent;
        tdUA.textContent = sess.userAgent;
        const tdTime = document.createElement('td');
        const date = new Date(sess.loginTime);
        tdTime.textContent = date.toLocaleString();
        const tdKick = document.createElement('td');
        const kickBtn = document.createElement('button');
        kickBtn.className = 'btn-small';
        kickBtn.textContent = "Đá";
        kickBtn.onclick = () => {
          // Remove this session
          const newSessions = sessions.filter(s => s.id !== sess.id);
          localStorage.setItem('sessions', JSON.stringify(newSessions));
          logHistory(`Đã đăng xuất phiên của user ID ${sess.userId}`);
          renderSessionsTable();
          alert("Đã đá thiết bị khỏi phiên đăng nhập.");
        };
        tdKick.appendChild(kickBtn);
        tr.appendChild(tdUser);
        tr.appendChild(tdUA);
        tr.appendChild(tdTime);
        tr.appendChild(tdKick);
        tbody.appendChild(tr);
      });
    }

    // Render history list
    function renderHistoryList() {
      const history = JSON.parse(localStorage.getItem('history') || '[]');
      const list = document.getElementById('history-list');
      list.innerHTML = "";
      // sort by newest first
      history.sort((a,b) => b.time - a.time);
      history.forEach(item => {
        const li = document.createElement('li');
        const d = new Date(item.time);
        let actionText = "";
        if (item.action === "reset") {
          actionText = `Reset mật khẩu tài khoản ${item.user}`;
        } else if (item.action === "grant") {
          actionText = `Cấp ${item.days} ngày cho tài khoản ${item.user}`;
        } else if (item.action === "logoutSession") {
          actionText = `Đăng xuất phiên của user ID ${item.userId}`;
        } else {
          actionText = item.description || item.action;
        }
        li.textContent = `${d.toLocaleString()} - ${actionText}`;
        list.appendChild(li);
      });
    }
    // Log an admin action to history
    function logHistory(description) {
      let history = JSON.parse(localStorage.getItem('history') || '[]');
      history.push({ time: Date.now(), action: "other", description: description });
      localStorage.setItem('history', JSON.stringify(history));
      renderHistoryList();
    }

    // On load, ensure admin user exists (already done), and possibly pre-fill for demo
    document.getElementById('admin-user').value = "admin";
    document.getElementById('admin-pass').value = "admin123";
  </script>
</body>
</html>
